"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.Environment=void 0;var fs=require("fs"),uuid_1=require("uuid"),stringify=require("json-stable-stringify"),Environment=function(){function t(){this.path="./environment",this.source="".concat(this.path,"/source.json"),this.outPath="".concat(this.path,"/output"),this.output={source:"".concat(this.outPath,"/source.json"),info:"".concat(this.outPath,"/info.txt"),index:"".concat(this.outPath,"/index.txt"),container:"".concat(this.outPath,"/container.env"),linux:"".concat(this.outPath,"/linux.txt"),windows:"".concat(this.outPath,"/windows.txt")},this.defaultEnvironment={production:!1}}return t.prototype.generateEnvironment=function(){this.initializeEnvironmentDirectories();var t=this.getEnvironmentObjectFromSource(),e=this.buildOutputFiles(t);for(var n in this.writeFile(this.output.source,JSON.stringify(t,null,4)),e)this.writeFile(this.output[n],e[n]);return this.validateIntegrity(t),this.resetSource(),e.info},t.prototype.buildOutputFiles=function(t){var e=Object.keys(t);if(!e.length)throw console.log(t),new Error("Couldnt build the output files because the environment object doesnt have valid keys.");for(var n,o,i=this.buildInfoFile(),r="",c="",a="",s="",u=0;u<e.length;u++)o="object"==typeof t[n=e[u]]?JSON.stringify(t[n]):t[n],c+="".concat(n,"=").concat(o,"\n"),r+="".concat(n,"\n").concat(o,"\n\n\n"),a+="export ".concat(n,"='").concat(o,"'"),s+="set ".concat(n,"='").concat(o,"'"),u!=e.length-1&&(a+=" && ",s+=" && ");return{info:i,index:r,container:c,linux:a,windows:s}},t.prototype.buildInfoFile=function(){var t=(0,uuid_1.v4)(),e=(new Date).toDateString(),n="ENVIRONMENT INFO\n\n";for(var o in n+="ID: ".concat(t,"\n\n"),n+="Date: ".concat(e,"\n\n"),n+="Files:\n",this.output)n+="".concat(this.output[o],"\n");return n},t.prototype.validateIntegrity=function(t){for(var e={},n=0,o=this.readFile(this.output.linux).split(" && ");n<o.length;n++){var i=o[n].replace("export ","").split("='");e[i[0]]=i[1].replace("'","")}for(var r in t)this.validatePropertyIntegrity(r,t[r],e[r])},t.prototype.validatePropertyIntegrity=function(t,e,n){var o=typeof e;switch(o){case"boolean":if(e!=("true"==n))throw console.log(e),console.log(n),new Error("Boolean Integrity Validation Failed: ".concat(t,"."));break;case"number":if(e!=Number(n))throw console.log(e),console.log(n),new Error("Number Integrity Validation Failed: ".concat(t,"."));break;case"object":var i=JSON.parse(n);if(stringify(e)!=stringify(i))throw console.log(e),console.log(i),new Error("Object Integrity Validation Failed: ".concat(t,"."));break;case"string":if(e!=n)throw console.log(e),console.log(n),new Error("String Integrity Validation Failed: ".concat(t,"."));break;default:throw new Error("The property (".concat(t,") has an invalid type (").concat(o,")."))}},t.prototype.getEnvironmentObjectFromSource=function(){var t=this.readFile(this.source);if("string"!=typeof t||!t.length)throw console.log(t),new Error("The extracted source is not a valid string.");try{return JSON.parse(t)}catch(t){throw console.error(t),new Error("The source content could not be converted into a JSON Object.")}},t.prototype.resetSource=function(){this.writeFile(this.source,JSON.stringify(this.defaultEnvironment,null,4))},t.prototype.initializeEnvironmentDirectories=function(){fs.mkdirSync("./environment",{recursive:!0}),fs.mkdirSync("./environment/output",{recursive:!0});try{fs.readFileSync(this.source,{encoding:"utf-8"})}catch(t){this.resetSource()}},t.prototype.readFile=function(t){return fs.readFileSync(t,{encoding:"utf-8"})},t.prototype.writeFile=function(t,e){fs.writeFileSync(t,e,{flag:"w"})},t}();exports.Environment=Environment;